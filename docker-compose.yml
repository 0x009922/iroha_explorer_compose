services:
  # Iroha
  # NOTE: These are mostly generated by `kagami swarm`
  irohad0:
    image: hyperledger/iroha:2.0.0-rc.2.0
    environment:
      CHAIN: 00000000-0000-0000-0000-000000000000
      PUBLIC_KEY: ed012004F79C976A13CFBD72DBBAA255C657E92655E95D8FBD21C0A1578536F5685CCE
      PRIVATE_KEY: 802620834BCEC4477C62ABC9EFBB6B147A5699CAFEE223DF385A8C53D9EBD320A8DBBF
      P2P_PUBLIC_ADDRESS: irohad0:1337
      P2P_ADDRESS: 0.0.0.0:1337
      API_ADDRESS: 0.0.0.0:8080
      GENESIS_PUBLIC_KEY: ed0120A5F4F231A1E8ACA399ACC5D967C37A672AC57CBB90DB72BCCC910A6EFC460380
      TRUSTED_PEERS: '["ed0120185C4176C23EE7F6F7B216E1C68D410982B400A86B0D709A845B39CBDCB56618@irohad3:1340","ed01207ED0E6A6AF830A033C596C57B06B776BF29B5A08FD7A13F3AD5BE8AE6128065D@irohad1:1338","ed0120E961C026752E68DCFE0BA9D47491AE853F7E3AE1775818F4D11DB8489C3C0C9F@irohad2:1339"]'
      GENESIS_PRIVATE_KEY: 80262074F42221C8E6DF699E64F1034C4B0E4AA38ADB614A72664E1314207BB193DDFD
      GENESIS: /tmp/genesis.signed.scale
      TOPOLOGY: '["ed012004F79C976A13CFBD72DBBAA255C657E92655E95D8FBD21C0A1578536F5685CCE","ed0120185C4176C23EE7F6F7B216E1C68D410982B400A86B0D709A845B39CBDCB56618","ed01207ED0E6A6AF830A033C596C57B06B776BF29B5A08FD7A13F3AD5BE8AE6128065D","ed0120E961C026752E68DCFE0BA9D47491AE853F7E3AE1775818F4D11DB8489C3C0C9F"]'
    volumes:
      - ./config:/config:ro
    init: true
    healthcheck:
      test: test $(curl -s http://127.0.0.1:8080/status/blocks) -gt 0
      interval: 2s
      timeout: 1s
      retries: 30
      start_period: 4s
    command: |-
      /bin/bash -c "
          EXECUTOR_RELATIVE_PATH=$(jq -r '.executor' /config/genesis.json) && \\
          EXECUTOR_ABSOLUTE_PATH=$(realpath \"/config/$$EXECUTOR_RELATIVE_PATH\") && \\
          WASM_DIR_RELATIVE_PATH=$(jq -r '.wasm_dir' /config/genesis.json) && \\
          WASM_DIR_ABSOLUTE_PATH=$(realpath \"/config/$$WASM_DIR_RELATIVE_PATH\") && \\
          jq \\
              --arg executor \"$$EXECUTOR_ABSOLUTE_PATH\" \\
              --arg wasm_dir \"$$WASM_DIR_ABSOLUTE_PATH\" \\
              --argjson topology \"$$TOPOLOGY\" \\
              '.executor = $$executor | .wasm_dir = $$wasm_dir | .topology = $$topology' /config/genesis.json \\
              >/tmp/genesis.json && \\
          kagami genesis sign /tmp/genesis.json \\
              --public-key $$GENESIS_PUBLIC_KEY \\
              --private-key $$GENESIS_PRIVATE_KEY \\
              --out-file $$GENESIS \\
          && \\
          exec irohad
      "
  irohad1:
    image: hyperledger/iroha:2.0.0-rc.2.0
    environment:
      CHAIN: 00000000-0000-0000-0000-000000000000
      PUBLIC_KEY: ed01207ED0E6A6AF830A033C596C57B06B776BF29B5A08FD7A13F3AD5BE8AE6128065D
      PRIVATE_KEY: 802620DF8B3645801D2D807C77F737DE4375EB56A726835B136A4BFA7FB792880796B9
      P2P_PUBLIC_ADDRESS: irohad1:1338
      P2P_ADDRESS: 0.0.0.0:1338
      API_ADDRESS: 0.0.0.0:8081
      GENESIS_PUBLIC_KEY: ed0120A5F4F231A1E8ACA399ACC5D967C37A672AC57CBB90DB72BCCC910A6EFC460380
      TRUSTED_PEERS: '["ed012004F79C976A13CFBD72DBBAA255C657E92655E95D8FBD21C0A1578536F5685CCE@irohad0:1337","ed0120185C4176C23EE7F6F7B216E1C68D410982B400A86B0D709A845B39CBDCB56618@irohad3:1340","ed0120E961C026752E68DCFE0BA9D47491AE853F7E3AE1775818F4D11DB8489C3C0C9F@irohad2:1339"]'
    volumes:
      - ./config:/config:ro
    init: true
  irohad2:
    image: hyperledger/iroha:2.0.0-rc.2.0
    environment:
      CHAIN: 00000000-0000-0000-0000-000000000000
      PUBLIC_KEY: ed0120E961C026752E68DCFE0BA9D47491AE853F7E3AE1775818F4D11DB8489C3C0C9F
      PRIVATE_KEY: 8026205E02883BF7AD1B0C5549CB34E2E96D381A578E9E10A6B441389BFF7846D74C9B
      P2P_PUBLIC_ADDRESS: irohad2:1339
      P2P_ADDRESS: 0.0.0.0:1339
      API_ADDRESS: 0.0.0.0:8082
      GENESIS_PUBLIC_KEY: ed0120A5F4F231A1E8ACA399ACC5D967C37A672AC57CBB90DB72BCCC910A6EFC460380
      TRUSTED_PEERS: '["ed012004F79C976A13CFBD72DBBAA255C657E92655E95D8FBD21C0A1578536F5685CCE@irohad0:1337","ed0120185C4176C23EE7F6F7B216E1C68D410982B400A86B0D709A845B39CBDCB56618@irohad3:1340","ed01207ED0E6A6AF830A033C596C57B06B776BF29B5A08FD7A13F3AD5BE8AE6128065D@irohad1:1338"]'
    volumes:
      - ./config:/config:ro
    init: true
  irohad3:
    image: hyperledger/iroha:2.0.0-rc.2.0
    environment:
      CHAIN: 00000000-0000-0000-0000-000000000000
      PUBLIC_KEY: ed0120185C4176C23EE7F6F7B216E1C68D410982B400A86B0D709A845B39CBDCB56618
      PRIVATE_KEY: 80262089815D6FFCF714FE333353D521D3185F0B5240DFA9BF22B6A04EB538AC0AF204
      P2P_PUBLIC_ADDRESS: irohad3:1340
      P2P_ADDRESS: 0.0.0.0:1340
      API_ADDRESS: 0.0.0.0:8083
      GENESIS_PUBLIC_KEY: ed0120A5F4F231A1E8ACA399ACC5D967C37A672AC57CBB90DB72BCCC910A6EFC460380
      TRUSTED_PEERS: '["ed012004F79C976A13CFBD72DBBAA255C657E92655E95D8FBD21C0A1578536F5685CCE@irohad0:1337","ed01207ED0E6A6AF830A033C596C57B06B776BF29B5A08FD7A13F3AD5BE8AE6128065D@irohad1:1338","ed0120E961C026752E68DCFE0BA9D47491AE853F7E3AE1775818F4D11DB8489C3C0C9F@irohad2:1339"]'
    volumes:
      - ./config:/config:ro
    init: true

  # Explorer

  iroha_explorer_backend:
    build: ./explorer_backend
    environment:
      IROHA_EXPLORER_ACCOUNT: ed0120CE7FA46C9DCE7EA4B125E2E36BDB63EA33073E7590AC92816AE1E861B7048B03@wonderland
      IROHA_EXPLORER_ACCOUNT_PRIVATE_KEY: 802620CCF31D85E3B32A4BEA59987CE0C78E3B8E2DB93881468AB2435FE45D5C9DCD53
      IROHA_EXPLORER_TORII_URLS: http://irohad0:8080,http://irohad1:8081,http://irohad2:8082,http://irohad3:8083
      IROHA_EXPLORER_IP: 0.0.0.0
      IROHA_EXPLORER_PORT: 8123
    # NOTE: useful for local frontend development, outside of the compose
    ports:
      8123:8123
    init: true

  iroha_explorer_web:
    build: ./explorer_web
    environment:
      BACKEND_HOST: iroha_explorer_backend
      BACKEND_PORT: 8123
    ports:
      - 8124:80

  producer:
    build: ./producer
    depends_on:
      irohad0:
        condition: service_healthy
    environment:
      TORII_URL: http://irohad0:8080
    init: true
